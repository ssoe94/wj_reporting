# Environment variable group to share secrets between services
envVarGroups:
  - name: shared-secrets
    # 중요: 이 그룹을 Render 대시보드의 "Environment" 탭에서 생성하고,
    # DATABASE_URL, SECRET_KEY 등 백엔드 서비스에 필요한 모든 비밀/환경 변수를 추가해야 합니다.

services:
  # Combined Frontend + Backend Web Service
  - type: web
    name: wj_reporting
    env: python
    buildCommand: |
      # Build frontend
      cd frontend && npm ci && npm run build && cd ..
      # Build backend
      cd backend && bash build.sh
    startCommand: cd backend && python manage.py migrate && python manage.py collectstatic --noinput && gunicorn config.wsgi:application --preload
    envVarGroup: shared-secrets

  # Daily Inventory Snapshot Cron Job
  - type: cron
    name: daily-inventory-snapshot
    env: python
    rootDir: backend
    schedule: "0 0 * * *"  # 00:00 UTC = 08:00 CST
    # Use the same build command as the backend for consistency
    buildCommand: bash build.sh
    # The management command should ideally get the date itself
    startCommand: python manage.py daily_snapshot_auto
    # Connect to the same shared environment variables to access the database etc.
    envVarGroup: shared-secrets

  # Hourly Injection Monitoring Snapshot
  - type: cron
    name: hourly-injection-snapshot
    env: python
    rootDir: backend
    schedule: "0 * * * *"  # Runs at the start of every hour (UTC)
    buildCommand: bash build.sh
    startCommand: python run_hourly_snapshot.py
    envVarGroup: shared-secrets
