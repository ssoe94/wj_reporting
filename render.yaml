# Environment variable group to share secrets between services
envVarGroups:
  - name: shared-secrets
    # NOTE: Create this group in Render > Environment and add secrets like
    # DATABASE_URL and SECRET_KEY there. These are shared by the backend and cron jobs.

services:
  # Frontend Static Site
  - type: static
    name: wj_reporting
    rootDir: frontend
    buildCommand: npm install && npm run build
    staticPublishPath: dist

  # Backend Web Service
  - type: web
    name: wj_reporting_backend
    env: python
    rootDir: backend
    buildCommand: bash build.sh
    startCommand: python manage.py migrate && gunicorn config.wsgi:application --preload
    envVarGroup: shared-secrets

  # Daily Inventory Snapshot Cron Job
  - type: cron
    name: daily-inventory-snapshot
    env: python
    rootDir: backend
    schedule: "0 0 * * *"  # 00:00 UTC = 08:00 CST
    # Use the same build command as the backend for consistency
    buildCommand: bash build.sh
    # The management command should ideally get the date itself
    startCommand: python manage.py daily_snapshot_auto
    # Connect to the same shared environment variables to access the database etc.
    envVarGroup: shared-secrets

  # Injection Monitoring Snapshot (every 10 minutes)
  - type: cron
    name: injection-snapshot-10min
    env: python
    rootDir: backend
    schedule: "*/10 * * * *"  # Runs every 10 minutes (UTC)
    buildCommand: bash build.sh
    startCommand: python run_hourly_snapshot.py
    envVarGroup: shared-secrets
