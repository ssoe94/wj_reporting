name: Test and Deploy

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

# ÎèôÏãú Î∞∞Ìè¨ Î∞©ÏßÄ
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1Îã®Í≥Ñ: ÌÖåÏä§Ìä∏ Ïã§Ìñâ
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          elif [ -f "frontend/package-lock.json" ]; then
            cd frontend && npm ci
          else
            echo "No package-lock.json found, skipping npm install"
          fi
      
      - name: Run linter (if available)
        run: |
          if [ -f "frontend/package.json" ]; then
            cd frontend
            npm run lint --if-present || echo "No lint script found"
          fi
      
      - name: Run unit tests (if available)
        run: |
          if [ -f "frontend/package.json" ]; then
            cd frontend
            npm run test:ci --if-present || npm run test --if-present || echo "No test script found"
          fi
      
      - name: Setup Python (for backend tests)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Run backend tests (if available)
        run: |
          if [ -f "backend/requirements.txt" ]; then
            cd backend
            pip install -r requirements.txt
            python manage.py test --no-input || echo "No backend tests found"
          fi
  
  # 2Îã®Í≥Ñ: Î∞∞Ìè¨ (main Î∏åÎûúÏπòÎßå, ÌÖåÏä§Ìä∏ ÌÜµÍ≥º Ïãú)
  deploy:
    name: Deploy to Render
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy Backend to Render
        run: |
          echo "üöÄ Deploying backend..."
          curl -fsS -X POST "$RENDER_DEPLOY_HOOK_BACKEND"
        env:
          RENDER_DEPLOY_HOOK_BACKEND: ${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}
      
      - name: Wait for backend deployment
        run: |
          echo "‚è≥ Waiting for backend to be healthy..."
          bash scripts/wait-health.sh https://wj-reporting-backend.onrender.com/api/health/ 300
      
      - name: Deploy Frontend to Render
        run: |
          echo "üöÄ Deploying frontend..."
          curl -fsS -X POST "$RENDER_DEPLOY_HOOK_FRONTEND"
        env:
          RENDER_DEPLOY_HOOK_FRONTEND: ${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}
      
      - name: Wait for frontend deployment
        run: |
          echo "‚è≥ Waiting for frontend to be ready..."
          sleep 60
  
  # 3Îã®Í≥Ñ: Î∞∞Ìè¨ ÌõÑ Í≤ÄÏ¶ù (smoke test)
  verify:
    name: Verify Deployment
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test Health Endpoint (JSON)
        run: |
          echo "Testing /api/health/ endpoint..."
          CONTENT_TYPE=$(curl -sI https://wj-reporting.onrender.com/api/health/ | grep -i content-type | awk '{print $2}' | tr -d '\r')
          echo "Content-Type: $CONTENT_TYPE"
          
          if [[ ! "$CONTENT_TYPE" =~ "application/json" ]]; then
            echo "‚ùå FAIL: Expected application/json, got $CONTENT_TYPE"
            exit 1
          fi
          echo "‚úÖ PASS: Health endpoint returns JSON"
      
      - name: Test Reports Summary (JSON)
        run: |
          echo "Testing /api/injection/reports/summary/ endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}\n%{content_type}" \
            "https://wj-reporting.onrender.com/api/injection/reports/summary/?date=2025-10-14")
          
          STATUS=$(echo "$RESPONSE" | tail -n 2 | head -n 1)
          CONTENT_TYPE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -2)
          
          echo "Status: $STATUS"
          echo "Content-Type: $CONTENT_TYPE"
          
          # Check if response is HTML (proxy failure)
          if [[ "$BODY" =~ "<html" ]] || [[ "$BODY" =~ "<!DOCTYPE" ]]; then
            echo "‚ùå FAIL: Received HTML instead of JSON"
            echo "Body preview: ${BODY:0:200}"
            exit 1
          fi
          
          # Check content type
          if [[ ! "$CONTENT_TYPE" =~ "application/json" ]]; then
            echo "‚ùå FAIL: Expected application/json, got $CONTENT_TYPE"
            exit 1
          fi
          
          echo "‚úÖ PASS: Reports endpoint returns JSON"
      
      - name: Test 404 Returns JSON
        run: |
          echo "Testing 404 error response format..."
          RESPONSE=$(curl -s -w "\n%{http_code}\n%{content_type}" \
            "https://wj-reporting.onrender.com/api/_404_check_nonexistent")
          
          STATUS=$(echo "$RESPONSE" | tail -n 2 | head -n 1)
          CONTENT_TYPE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -2)
          
          echo "Status: $STATUS"
          echo "Content-Type: $CONTENT_TYPE"
          
          # Should be 404
          if [ "$STATUS" != "404" ]; then
            echo "‚ö†Ô∏è  WARNING: Expected 404, got $STATUS"
          fi
          
          # Should be JSON, not HTML
          if [[ "$BODY" =~ "<html" ]] || [[ "$BODY" =~ "<!DOCTYPE" ]]; then
            echo "‚ùå FAIL: 404 returns HTML instead of JSON"
            echo "Body preview: ${BODY:0:200}"
            exit 1
          fi
          
          if [[ ! "$CONTENT_TYPE" =~ "application/json" ]]; then
            echo "‚ùå FAIL: 404 should return JSON, got $CONTENT_TYPE"
            exit 1
          fi
          
          echo "‚úÖ PASS: 404 errors return JSON"
      
      - name: Test Backend Direct
        run: |
          echo "Testing backend direct access..."
          CONTENT_TYPE=$(curl -sI https://wj-reporting-backend.onrender.com/api/health/ \
            | grep -i content-type | awk '{print $2}' | tr -d '\r')
          echo "Backend Content-Type: $CONTENT_TYPE"
          
          if [[ ! "$CONTENT_TYPE" =~ "application/json" ]]; then
            echo "‚ùå FAIL: Backend should return JSON"
            exit 1
          fi
          echo "‚úÖ PASS: Backend returns JSON"
      
      - name: Run full verification script
        run: |
          echo "üîç Running comprehensive verification..."
          bash scripts/quick-smoke-test.sh
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "‚úÖ Deployment Verification Complete"
          echo "========================================="
          echo "All critical endpoints validated for:"
          echo "  ‚úì JSON content-type"
          echo "  ‚úì No HTML responses"
          echo "  ‚úì Proper error handling"
          echo "  ‚úì Proxy routing"
          echo "  ‚úì Cache headers"
          echo "========================================="
          echo ""
          echo "üéâ Deployment successful!"
  
  # PRÏö© Ïä§Î™®ÌÅ¨ ÌÖåÏä§Ìä∏ (Î∞∞Ìè¨ ÏóÜÏù¥ Í∏∞Ï°¥ ÌôòÍ≤Ω Í≤ÄÏ¶ù)
  pr-smoke-test:
    name: PR Smoke Test
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test current production endpoints
        run: |
          echo "üîç Testing current production environment..."
          
          # Health check
          curl -fsS https://wj-reporting.onrender.com/api/health/ | grep -q "status" || exit 1
          echo "‚úì Health check passed"
          
          # JSON validation
          CONTENT_TYPE=$(curl -sI https://wj-reporting.onrender.com/api/health/ | grep -i content-type | awk '{print $2}' | tr -d '\r')
          if [[ "$CONTENT_TYPE" =~ "application/json" ]]; then
            echo "‚úì JSON content-type verified"
          else
            echo "‚úó Expected JSON, got $CONTENT_TYPE"
            exit 1
          fi
      
      - name: Summary
        run: |
          echo ""
          echo "========================================="
          echo "‚úÖ PR Smoke Test Complete"
          echo "========================================="
          echo "Production environment is healthy."
          echo "Ready to merge after review."
          echo "========================================="
